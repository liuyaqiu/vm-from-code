---
# This task file creates a single VM instance using Terraform
# Uses the Ansible-defined configuration and generates Terraform config

- name: Check if source image exists
  stat:
    path: "{{ source_image_path }}"
  register: source_image_stat
  tags: image

- name: Copy source image to libvirt images directory with VM-specific name
  copy:
    src: "{{ source_image_path }}"
    dest: "{{ base_image_path }}/{{ replica_vm_name }}.qcow2"
    mode: '0644'
    remote_src: true
  when: source_image_stat.stat.exists
  tags: image

- name: "Create Terraform working directory for {{ replica_vm_name }}"
  file:
    path: "terraform/{{ target_vm }}"
    state: directory
    mode: '0755'
  tags: terraform

- name: "Create cloud-init config directory for {{ replica_vm_name }}"
  file:
    path: "/tmp/cloud-init-{{ replica_vm_name }}"
    state: directory
    mode: '0755'
  tags: cloud-init

- name: Read SSH public key content
  slurp:
    src: "{{ vm_ssh_public_key_path }}"
  register: ssh_public_key_content
  delegate_to: localhost
  become: false
  tags: cloud-init

- name: Set SSH key content as a separate variable
  set_fact:
    vm_ssh_key: "{{ ssh_public_key_content.content | b64decode | trim }}"
  tags: cloud-init

- name: "Generate cloud-init user-data for {{ replica_vm_name }}"
  template:
    src: user-data.j2
    dest: "/tmp/cloud-init-{{ replica_vm_name }}/user-data"
    mode: '0644'
  tags: cloud-init
  vars:
    # Override variables for this replica
    replica_config:
      vm_name: "{{ replica_vm_name }}"
      vm_hostname: "{{ replica_hostname }}"
      vm_static_ip: "{{ replica_static_ip }}"
      vm_mac_address: "{{ replica_mac_address }}"

- name: "Generate cloud-init meta-data for {{ replica_vm_name }}"
  template:
    src: meta-data.j2
    dest: "/tmp/cloud-init-{{ replica_vm_name }}/meta-data"
    mode: '0644'
  tags: cloud-init
  vars:
    replica_config:
      vm_name: "{{ replica_vm_name }}"
      vm_hostname: "{{ replica_hostname }}"

- name: "Generate cloud-init network-config for {{ replica_vm_name }}"
  template:
    src: network-config.j2
    dest: "/tmp/cloud-init-{{ replica_vm_name }}/network-config"
    mode: '0644'
  tags: cloud-init
  vars:
    replica_config:
      vm_static_ip: "{{ replica_static_ip }}"
      vm_mac_address: "{{ replica_mac_address }}"

- name: "Read cloud-init user-data content"
  slurp:
    src: "/tmp/cloud-init-{{ replica_vm_name }}/user-data"
  register: user_data_file
  tags: terraform

- name: "Read cloud-init meta-data content"
  slurp:
    src: "/tmp/cloud-init-{{ replica_vm_name }}/meta-data"
  register: meta_data_file
  tags: terraform

- name: "Read cloud-init network-config content"
  slurp:
    src: "/tmp/cloud-init-{{ replica_vm_name }}/network-config"
  register: network_config_file
  tags: terraform

- name: "Set cloud-init content variables"
  set_fact:
    user_data_content: "{{ user_data_file.content | b64decode }}"
    meta_data_content: "{{ meta_data_file.content | b64decode }}"
    network_config_content: "{{ network_config_file.content | b64decode }}"
  tags: terraform

- name: "Generate Terraform provider configuration (run once)"
  template:
    src: terraform-provider.tf.j2
    dest: "terraform/{{ target_vm }}/provider.tf"
    mode: '0644'
  when: replica_index == 0
  tags: terraform

- name: "Generate Terraform VM resources for {{ replica_vm_name }}"
  template:
    src: vm-terraform.tf.j2
    dest: "terraform/{{ target_vm }}/{{ replica_vm_name }}.tf"
    mode: '0644'
  tags: terraform
  vars:
    replica_config:
      vm_name: "{{ replica_vm_name }}"
      vm_hostname: "{{ replica_hostname }}"
      vm_memory: "{{ vm_config.vm_memory }}"
      vm_vcpus: "{{ vm_config.vm_vcpus }}"
      vm_disk_size: "{{ vm_config.vm_disk_size | default(default_vm_disk_size) }}"
      vm_mac_address: "{{ replica_mac_address }}"
      vm_static_ip: "{{ replica_static_ip }}"
      vm_autostart: "{{ vm_config.vm_autostart | default(true) }}"
      gpu_passthrough: "{{ vm_config.gpu_passthrough | default(false) }}"
      gpu_device_id: "{{ vm_config.gpu_device_id | default('') }}"

- name: "Initialize Terraform for {{ target_vm }} (run once)"
  command: terraform init
  args:
    chdir: "terraform/{{ target_vm }}"
  register: terraform_init
  changed_when: "'Terraform has been successfully initialized' in terraform_init.stdout"
  when: replica_index == 0
  tags: terraform

- name: "Display Terraform init output for {{ target_vm }}"
  debug:
    msg: "{{ terraform_init.stdout_lines }}"
  when: replica_index == 0
  tags: terraform

- name: "Validate Terraform configuration for {{ target_vm }} (run once)"
  command: terraform validate
  args:
    chdir: "terraform/{{ target_vm }}"
  register: terraform_validate
  changed_when: false
  when: replica_index == 0
  tags: terraform

- name: "Display Terraform validate output for {{ target_vm }}"
  debug:
    msg: "{{ terraform_validate.stdout_lines }}"
  when: replica_index == 0
  tags: terraform

- name: "Apply Terraform configuration for {{ target_vm }}"
  command: terraform apply -auto-approve
  args:
    chdir: "terraform/{{ target_vm }}"
  register: terraform_apply
  when: replica_index == 0
  tags: [terraform, apply]

- name: "Display Terraform apply output for {{ target_vm }}"
  debug:
    msg: "{{ terraform_apply.stdout_lines }}"
  when: replica_index == 0
  tags: [terraform, apply]

- name: "Display VM information for {{ replica_vm_name }}"
  pause:
    echo: false
    seconds: 1
    prompt: |
      âœ… VM '{{ replica_vm_name }}' has been created and started via Terraform.
      IP: {{ replica_static_ip }}
      Connect via VNC: virt-viewer {{ replica_vm_name }}
      Or use SSH once the VM is fully booted: ssh {{ vm_ssh_user }}@{{ replica_static_ip }}

      Terraform state: terraform/{{ target_vm }}/
  tags: info
  when: replica_index == 0
