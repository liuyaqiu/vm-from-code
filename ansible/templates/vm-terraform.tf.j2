{% set config = replica_config | default(vm_config) %}
# Terraform VM resources for {{ config.vm_name }}
# Generated by Ansible from vm-terraform.tf.j2 template
# Provider configuration is in provider.tf

# VM disk - directly use the Packer-built image file
# No need for base volume - use file type disk like Ansible-created VMs

# Cloud-init seed ISO
resource "libvirt_cloudinit_disk" "{{ config.vm_name }}_seed" {
  name = "{{ config.vm_name }}-cloudinit"

  user_data = <<-EOF
{{ user_data_content }}
  EOF

  meta_data = <<-EOF
{{ meta_data_content }}
  EOF

  network_config = <<-EOF
{{ network_config_content }}
  EOF
}

# Upload the cloud-init ISO into the pool
resource "libvirt_volume" "{{ config.vm_name }}_seed_volume" {
  name = "{{ config.vm_name }}-cloudinit.iso"
  pool = "default"

  create = {
    content = {
      url = libvirt_cloudinit_disk.{{ config.vm_name }}_seed.path
    }
  }
}

# Virtual machine definition
resource "libvirt_domain" "{{ config.vm_name }}" {
  name   = "{{ config.vm_name }}"
  memory = {{ (config.vm_memory | default(default_vm_memory) | int) * 1024 }}  # Convert MB to KB
  vcpu   = {{ config.vm_vcpus | default(default_vm_vcpus) }}
  type   = "kvm"

  os = {
    type         = "hvm"
    type_arch    = "x86_64"
    type_machine = "q35"

    features = {
      acpi = {}
      apic = {}
      vmport = {
        state = "off"
      }
    }
  }

  cpu = {
    mode = "host-passthrough"
  }

  pm = {
    suspend_to_mem = {
      enabled = "no"
    }
    suspend_to_disk = {
      enabled = "no"
    }
  }

  devices = {
    disks = [
      {
        driver = {
          type = "qcow2"
        }
        source = {
          file = {
            file = "{{ base_image_path }}/{{ config.vm_name }}.qcow2"
          }
        }
        target = {
          dev = "vda"
          bus = "virtio"
        }
        boot_order = 1
      },
      {
        device = "cdrom"
        source = {
          volume = {
            pool   = libvirt_volume.{{ config.vm_name }}_seed_volume.pool
            volume = libvirt_volume.{{ config.vm_name }}_seed_volume.name
          }
        }
        target = {
          dev = "sda"
          bus = "sata"
        }
        boot_order = 2
      }
    ]

    interfaces = [
      {
        model = {
          type = "virtio"
        }
{% if config.vm_mac_address is defined %}
        mac_address = "{{ config.vm_mac_address }}"
{% endif %}
        source = {
          # use host machines existing bridge
          bridge = {
            bridge = "{{ libvirt_bridge }}"
          }
        }
        # NOTE: PCI address for interface - this forces interface to bus 01
        # This is necessary to avoid conflict with filesystem device on bus 02
        address = {
          pci = {
            domain = 0
            bus = 1
            slot = 0
            function = 0
          }
        }
      }
    ]

    graphics = [
      {
        vnc = {
          auto_port = true
          listen    = "127.0.0.1"
        }
      }
    ]

    serials = [
      {
        type = "pty"
        target_port = 0
      }
    ]

    consoles = [
      {
        type        = "pty"
        target_type = "serial"
        target_port = 0
      }
    ]

    rng = {
      model = "virtio"
    }
{% if vm_config.shared_folders is defined and vm_config.shared_folders | length > 0 %}

    filesystems = [
{% for folder in vm_config.shared_folders %}
      {
        source = {
          mount = {
            dir = "{{ folder.source }}"
          }
        }
        target = {
          dir = "{{ folder.tag }}"
        }
        access_mode = "passthrough"
        # NOTE: PCI address for filesystem - place on bus 02+ to avoid conflict with network on bus 01
        address = {
          pci = {
            domain = 0
            bus = {{ loop.index + 1 }}  # Start from bus 0x02 (0x01 is reserved for network)
            slot = 0
            function = 0
          }
        }
      }{% if not loop.last %},{% endif %}

{% endfor %}
    ]
{% endif %}
{% if config.gpu_passthrough | default(false) %}

    hostdevs = [
      {
        managed = true
        subsys_pci = {
          source = {
            address = {
{% set domain = config.gpu_device_id.split(':')[0] | int(base=16) %}
{% set bus = config.gpu_device_id.split(':')[1] | int(base=16) %}
{% set slot = config.gpu_device_id.split(':')[2].split('.')[0] | int(base=16) %}
{% set function = config.gpu_device_id.split(':')[2].split('.')[1] | int(base=16) %}
{% if domain != 0 %}
              domain   = {{ domain }}
{% endif %}
{% if bus != 0 %}
              bus      = {{ bus }}
{% endif %}
{% if slot != 0 %}
              slot     = {{ slot }}
{% endif %}
{% if function != 0 %}
              function = {{ function }}
{% endif %}
            }
          }
        }
      }
    ]
{% endif %}
  }

  running = {{ config.vm_autostart | default(true) | lower }}
}

# Output VM connection information
output "{{ config.vm_name }}_ip" {
  value = "{{ config.vm_static_ip }}"
  description = "Static IP address of {{ config.vm_name }}"
}

output "{{ config.vm_name }}_connection" {
  value = "ssh {{ vm_ssh_user }}@{{ config.vm_static_ip }}"
  description = "SSH connection command for {{ config.vm_name }}"
}
