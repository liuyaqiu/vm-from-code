#cloud-config
# DEPLOYMENT-TIME cloud-init configuration for clean Packer-built base image
# This VM uses a base image with reset cloud-init state, so we can configure cleanly
{% set config = replica_config | default(vm_config) %}

# Set hostname for this deployment
hostname: {{ config.vm_hostname | default(config.vm_name) }}
fqdn: {{ config.vm_hostname | default(config.vm_name) }}.local

# User configuration (vagrant user exists from base image, ensure password login works)
users:
  - name: vagrant
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: sudo
    shell: /bin/bash
    lock_passwd: false
    # Keep the password: vagrant (hashed)
    passwd: $6$R4BhFdKhYX9qD9lS$7dpmvCiT70Rici8D.3M2uMYD0AeOBrP49UnUvHesqMgPARjQoMxJx2DX/Ax2CaeVxU03qyjT.wMRPAjkEYO2l0
    ssh_authorized_keys:
      - {{ vm_ssh_key }}

# SSH configuration - ensure password authentication is enabled
ssh_pwauth: true
disable_root: true

# Write deployment-specific files
write_files:
  - path: /etc/motd
    content: |
      Welcome to {{ config.vm_name }}

      This VM was deployed with:
      - Static IP: {{ config.vm_static_ip | default('192.168.122.30') }}
      - Memory: {{ config.vm_memory | default(vm_config.vm_memory) | default('2048') }}MB
      - CPUs: {{ config.vm_vcpus | default(vm_config.vm_vcpus) | default('2') }}

      Login: ssh vagrant@{{ config.vm_static_ip | default('192.168.122.30') }}
      Password: vagrant

      Built with Packer + Ansible cloud-init workflow
    permissions: '0644'
  - path: /etc/ssh/sshd_config.d/50-vagrant-password-auth.conf
    content: |
      # Enable password authentication for vagrant user
      PasswordAuthentication yes
      PubkeyAuthentication yes
      AuthorizedKeysFile %h/.ssh/authorized_keys
      PermitRootLogin no
    permissions: '0644'


{% if vm_config.vm_packages is defined and vm_config.vm_packages | length > 0 %}
# Install deployment-specific packages
packages:
{% for package in vm_config.vm_packages %}
  - {{ package }}
{% endfor %}
{% endif %}

# Deployment-specific commands
runcmd:
  - echo "=== Cloud-init configuration complete ==="
  - echo "Deployment cloud-init completed for {{ config.vm_name }}"
  - 'echo "Static IP configured: {{ config.vm_static_ip | default("192.168.122.30") }}"'
  - echo "Password authentication enabled for vagrant user"
  - systemctl restart ssh
{% if vm_config.shared_folders is defined and vm_config.shared_folders | length > 0 %}
  # Setup shared folders with virtio-9p
  - echo "=== Setting up shared folders ==="
{% for folder in vm_config.shared_folders %}
  # Create mount point for {{ folder.tag }}
  - mkdir -p {{ folder.target }}
  - chown vagrant:vagrant {{ folder.target }}
  # Add fstab entry for {{ folder.tag }}
  - |
    if ! grep -q "{{ folder.tag }}" /etc/fstab; then
      echo "{{ folder.tag }}   {{ folder.target }}   9p   trans=virtio,version=9p2000.L,rw,_netdev   0   0" >> /etc/fstab
    fi
{% endfor %}
  # Apply mounts
  - systemctl daemon-reload
  - mount -a
  - echo "=== Shared folders setup complete ==="
{% endif %}
{% if vm_config.custom_packages is defined and vm_config.custom_packages | length > 0 %}
  # Install custom deb packages with retry logic
  - echo "=== Installing custom packages ==="
{% for package in vm_config.custom_packages %}
  - |
    # Download {{ package.name }} with retry (max 3 attempts)
    for attempt in 1 2 3; do
      echo "Attempt $attempt: Downloading {{ package.name }}..."
      if wget -O /tmp/{{ package.name }} {{ package.url }}; then
        echo "Download successful"
        break
      else
        echo "Download failed"
        if [ $attempt -lt 3 ]; then
          echo "Waiting 15 seconds before retry..."
          sleep 15
        else
          echo "Max retries reached, installation will fail"
        fi
      fi
    done
  - dpkg -i /tmp/{{ package.name }} || apt install -f -y
  - rm -f /tmp/{{ package.name }}
{% endfor %}
  - echo "=== Custom packages installation complete ==="
{% endif %}
{% if vm_config.install_docker | default(false) %}
  # Install Docker and Docker Compose
  - echo "=== Installing Docker ==="
  - apt install -y ca-certificates curl
  - install -m 0755 -d /etc/apt/keyrings
  - curl -fsSL https://download.docker.com/linux/ubuntu/gpg -o /etc/apt/keyrings/docker.asc
  - chmod a+r /etc/apt/keyrings/docker.asc
  - echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/ubuntu $(. /etc/os-release && echo \"$VERSION_CODENAME\") stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
  - apt update
  - apt install -y docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin
  - usermod -aG docker vagrant
  - systemctl enable docker
  - systemctl start docker
  - echo "=== Docker installation complete ==="
{% endif %}
{% if vm_config.install_nvidia | default(false) %}
  # Install NVIDIA driver and utils
  - echo "=== Installing NVIDIA drivers ==="
  - apt install -y linux-headers-$(uname -r)
  - wget -O /tmp/cuda-keyring.deb https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2404/x86_64/cuda-keyring_1.1-1_all.deb
  - dpkg -i /tmp/cuda-keyring.deb
  - rm /tmp/cuda-keyring.deb
  - apt update
  - apt upgrade
  - apt install -y nvidia-driver-pinning-590
  - apt install -y libnvidia-compute
  - apt install -y nvidia-dkms-open
  - apt install -y cuda-toolkit-13-1
  - |
    # Add CUDA to PATH and LD_LIBRARY_PATH for vagrant user
    echo 'export PATH="/usr/local/cuda/bin:$PATH"' >> /home/vagrant/.bashrc
    echo 'export LD_LIBRARY_PATH="/usr/local/cuda/lib64:$LD_LIBRARY_PATH"' >> /home/vagrant/.bashrc
    chown vagrant:vagrant /home/vagrant/.bashrc
  - echo "=== NVIDIA driver installation complete (reboot required) ==="
  - reboot
{% endif %}

# Final message
final_message: |
  {{ config.vm_name }} deployment completed successfully!

  Connection details:
  - SSH: ssh vagrant@{{ config.vm_static_ip | default('192.168.122.30') }}
  - Password: vagrant
  - Static IP: {{ config.vm_static_ip | default('192.168.122.30') }}

  This VM was deployed from a clean Packer base image.
